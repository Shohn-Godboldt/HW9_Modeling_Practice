---
title: "HW 9 - Modeling Practice"
author: "Shohn Godboldt"
format:
  html:
    df-print: paged
editor: visual
---

```{r}
#| message: false
#| warning: false

library(tidyverse)
library(tidymodels)
library(janitor)
library(rpart.plot)
library(vip)
library(baguette)

set.seed(123)
```

## Data import and preprocessing

In this homework I continue working with the Seoul bike sharing data I used
in Homework 8. My goal is to compare several modeling approaches for
predicting the **rented bike count** using the remaining variables as
predictors.

```{r}
bike_raw <- read_csv(
  "SeoulBikeData.csv",
  locale = locale(encoding = "latin1"),
  show_col_types = FALSE
)

bike <- bike_raw %>% clean_names()
glimpse(bike)
```

```{r}
bike <- bike %>%
  mutate(
    holiday         = factor(holiday),
    seasons         = factor(seasons),
    functioning_day = factor(functioning_day)
  )

if ("date" %in% names(bike)) {
  bike <- bike %>% select(-date)
}
```

```{r}
set.seed(123)
bike_split <- initial_split(bike, prop = 0.8, strata = rented_bike_count)
bike_train <- training(bike_split)
bike_test  <- testing(bike_split)

set.seed(123)
bike_folds <- vfold_cv(bike_train, v = 10, strata = rented_bike_count)
```

## Baseline recipe

```{r}
bike_rec <- recipe(rented_bike_count ~ ., data = bike_train) %>%
  step_dummy(all_nominal_predictors()) %>%
  step_zv(all_predictors()) %>%
  step_normalize(all_numeric_predictors())
bike_rec
```

## 1. Multiple Linear Regression (MLR)

```{r}
mlr_spec <- linear_reg() %>% set_engine("lm")

mlr_wf <- workflow() %>%
  add_model(mlr_spec) %>%
  add_recipe(bike_rec)

mlr_fit <- mlr_wf %>% fit(data = bike_train)

mlr_test_preds <- predict(mlr_fit, new_data = bike_test) %>% bind_cols(bike_test)

mlr_test_metrics <- mlr_test_preds %>%
  metrics(truth = rented_bike_count, estimate = .pred) %>%
  filter(.metric %in% c("rmse","mae"))

mlr_test_metrics
```

```{r}
mlr_coefs <- mlr_fit %>% extract_fit_parsnip() %>% tidy()
mlr_coefs
```

## 2. LASSO Model

```{r}
lasso_spec <- linear_reg(penalty = tune(), mixture = 1) %>% set_engine("glmnet")

lasso_wf <- workflow() %>% add_model(lasso_spec) %>% add_recipe(bike_rec)

lasso_grid <- grid_regular(penalty(range = c(-4,0)), levels = 20)

lasso_res <- lasso_wf %>%
  tune_grid(resamples = bike_folds, grid = lasso_grid, metrics = metric_set(rmse,mae))

best_lasso <- lasso_res %>% select_best(metric="rmse")
best_lasso
```

```{r}
final_lasso_wf <- lasso_wf %>% finalize_workflow(best_lasso)
final_lasso_fit <- final_lasso_wf %>% fit(data=bike_train)

lasso_test_preds <- predict(final_lasso_fit, new_data=bike_test) %>% bind_cols(bike_test)

lasso_test_metrics <- lasso_test_preds %>%
  metrics(truth=rented_bike_count, estimate=.pred) %>%
  filter(.metric %in% c("rmse","mae"))

lasso_test_metrics
```

```{r}
lasso_coefs <- final_lasso_fit %>% extract_fit_parsnip() %>% tidy()
lasso_coefs
```

## 3. Regression Tree

```{r}
tree_spec <- decision_tree(cost_complexity=tune(), tree_depth=tune(), min_n=tune()) %>%
  set_engine("rpart") %>% set_mode("regression")

tree_wf <- workflow() %>% add_model(tree_spec) %>% add_recipe(bike_rec)

tree_grid <- grid_regular(
  cost_complexity(range=c(-4,-1)),
  tree_depth(range=c(2,10)),
  min_n(range=c(5,30)),
  levels=4
)

tree_res <- tree_wf %>%
  tune_grid(resamples=bike_folds, grid=tree_grid, metrics=metric_set(rmse,mae))

best_tree <- tree_res %>% select_best(metric="rmse")
best_tree
```

```{r}
final_tree_wf <- tree_wf %>% finalize_workflow(best_tree)
final_tree_fit <- final_tree_wf %>% fit(data=bike_train)

tree_test_preds <- predict(final_tree_fit, new_data=bike_test) %>% bind_cols(bike_test)

tree_test_metrics <- tree_test_preds %>%
  metrics(truth=rented_bike_count, estimate=.pred) %>%
  filter(.metric %in% c("rmse","mae"))

tree_test_metrics
```

```{r}
tree_fit_obj <- final_tree_fit %>% extract_fit_parsnip() %>% pluck("fit")
rpart.plot(tree_fit_obj)
```

## 4. Bagged Tree

```{r}
bag_spec <- bag_tree(tree_depth=tune(), min_n=tune()) %>%
  set_engine("rpart", times=50) %>% set_mode("regression")

bag_wf <- workflow() %>% add_model(bag_spec) %>% add_recipe(bike_rec)

bag_grid <- grid_regular(
  tree_depth(range=c(2,10)),
  min_n(range=c(5,30)),
  levels=5
)

bag_res <- bag_wf %>%
  tune_grid(resamples=bike_folds, grid=bag_grid, metrics=metric_set(rmse,mae))

best_bag <- bag_res %>% select_best(metric="rmse")
best_bag
```

```{r}
final_bag_wf <- bag_wf %>% finalize_workflow(best_bag)
final_bag_fit <- final_bag_wf %>% fit(data=bike_train)

bag_test_preds <- predict(final_bag_fit, new_data=bike_test) %>% bind_cols(bike_test)

bag_test_metrics <- bag_test_preds %>%
  metrics(truth=rented_bike_count, estimate=.pred) %>%
  filter(.metric %in% c("rmse","mae"))

bag_test_metrics
```



## 5. Random Forest

```{r}
rf_spec <- rand_forest(mtry=tune(), trees=500, min_n=tune()) %>%
  set_engine("ranger", importance="impurity") %>%
  set_mode("regression")

rf_wf <- workflow() %>% add_model(rf_spec) %>% add_recipe(bike_rec)

rf_grid <- grid_regular(
  mtry(range=c(3,15)),
  min_n(range=c(5,30)),
  levels=5
)

rf_res <- rf_wf %>%
  tune_grid(resamples=bike_folds, grid=rf_grid, metrics=metric_set(rmse,mae))

best_rf <- rf_res %>% select_best(metric="rmse")
best_rf
```

```{r}
final_rf_wf <- rf_wf %>% finalize_workflow(best_rf)
final_rf_fit <- final_rf_wf %>% fit(data=bike_train)

rf_test_preds <- predict(final_rf_fit, new_data=bike_test) %>% bind_cols(bike_test)

rf_test_metrics <- rf_test_preds %>%
  metrics(truth=rented_bike_count, estimate=.pred) %>%
  filter(.metric %in% c("rmse","mae"))

rf_test_metrics
```

```{r}
vip(final_rf_fit %>% extract_fit_parsnip())
```

## Compare All Models

```{r}
model_metrics <- bind_rows(
  mlr_test_metrics %>% mutate(model="MLR"),
  lasso_test_metrics %>% mutate(model="LASSO"),
  tree_test_metrics %>% mutate(model="Regression Tree"),
  bag_test_metrics %>% mutate(model="Bagged Tree"),
  rf_test_metrics %>% mutate(model="Random Forest")
)

model_metrics
```

## Fit Best Model to Full Data

```{r}
final_best_wf <- final_rf_wf
best_full_fit <- final_best_wf %>% fit(data=bike)
best_full_fit
```
